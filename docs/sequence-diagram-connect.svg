<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 520" font-family="system-ui, -apple-system, sans-serif">
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#374151"/>
    </marker>
    <marker id="arrowhead-blue" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#3b82f6"/>
    </marker>
    <marker id="arrowhead-green" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#10b981"/>
    </marker>
  </defs>
  
  <!-- Background -->
  <rect width="900" height="520" fill="#f8fafc"/>
  
  <!-- Title -->
  <text x="450" y="35" text-anchor="middle" font-size="18" font-weight="bold" fill="#1e293b">连接建立时序图 (Connection Establishment)</text>
  
  <!-- Actors -->
  <rect x="60" y="60" width="100" height="40" rx="6" fill="#3b82f6" stroke="#2563eb" stroke-width="2"/>
  <text x="110" y="85" text-anchor="middle" fill="white" font-size="13" font-weight="600">VS Code</text>
  
  <rect x="260" y="60" width="100" height="40" rx="6" fill="#8b5cf6" stroke="#7c3aed" stroke-width="2"/>
  <text x="310" y="85" text-anchor="middle" fill="white" font-size="13" font-weight="600">Bridge Server</text>
  
  <rect x="460" y="60" width="100" height="40" rx="6" fill="#f59e0b" stroke="#d97706" stroke-width="2"/>
  <text x="510" y="85" text-anchor="middle" fill="white" font-size="13" font-weight="600">Offscreen.js</text>
  
  <rect x="660" y="60" width="100" height="40" rx="6" fill="#ef4444" stroke="#dc2626" stroke-width="2"/>
  <text x="710" y="85" text-anchor="middle" fill="white" font-size="13" font-weight="600">Background.js</text>
  
  <rect x="800" y="60" width="80" height="40" rx="6" fill="#10b981" stroke="#059669" stroke-width="2"/>
  <text x="840" y="85" text-anchor="middle" fill="white" font-size="13" font-weight="600">Popup</text>
  
  <!-- Lifelines -->
  <line x1="110" y1="100" x2="110" y2="500" stroke="#94a3b8" stroke-width="2" stroke-dasharray="6,4"/>
  <line x1="310" y1="100" x2="310" y2="500" stroke="#94a3b8" stroke-width="2" stroke-dasharray="6,4"/>
  <line x1="510" y1="100" x2="510" y2="500" stroke="#94a3b8" stroke-width="2" stroke-dasharray="6,4"/>
  <line x1="710" y1="100" x2="710" y2="500" stroke="#94a3b8" stroke-width="2" stroke-dasharray="6,4"/>
  <line x1="840" y1="100" x2="840" y2="500" stroke="#94a3b8" stroke-width="2" stroke-dasharray="6,4"/>
  
  <!-- Step 1: Start Server -->
  <rect x="85" y="130" width="50" height="30" fill="#dbeafe" stroke="#3b82f6" stroke-width="1"/>
  <line x1="110" y1="160" x2="310" y2="160" stroke="#3b82f6" stroke-width="2" marker-end="url(#arrowhead-blue)"/>
  <text x="210" y="152" text-anchor="middle" fill="#1e40af" font-size="11" font-weight="500">1. startServer(port:17321)</text>
  
  <!-- Step 2: Server Listen -->
  <rect x="285" y="170" width="50" height="25" fill="#ede9fe" stroke="#8b5cf6" stroke-width="1"/>
  <text x="310" y="208" text-anchor="middle" fill="#6d28d9" font-size="10">listening on 127.0.0.1:17321</text>
  
  <!-- Step 3: User clicks Connect in Popup -->
  <rect x="815" y="230" width="50" height="25" fill="#d1fae5" stroke="#10b981" stroke-width="1"/>
  <line x1="840" y1="255" x2="710" y2="255" stroke="#10b981" stroke-width="2" marker-end="url(#arrowhead-green)"/>
  <text x="775" y="247" text-anchor="middle" fill="#047857" font-size="11" font-weight="500">2. {type:"connect"}</text>
  
  <!-- Step 4: Background ensures Offscreen -->
  <rect x="685" y="265" width="50" height="25" fill="#fef3c7" stroke="#f59e0b" stroke-width="1"/>
  <line x1="710" y1="290" x2="510" y2="290" stroke="#f59e0b" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="610" y="282" text-anchor="middle" fill="#b45309" font-size="11" font-weight="500">3. ensureOffscreen()</text>
  
  <!-- Step 5: Offscreen creates WebSocket -->
  <rect x="485" y="300" width="50" height="25" fill="#fef3c7" stroke="#f59e0b" stroke-width="1"/>
  <line x1="510" y1="325" x2="310" y2="325" stroke="#374151" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="410" y="317" text-anchor="middle" fill="#374151" font-size="11" font-weight="500">4. new WebSocket(ws://127.0.0.1:17321)</text>
  
  <!-- Step 6: WS Open -->
  <line x1="310" y1="350" x2="510" y2="350" stroke="#10b981" stroke-width="2" stroke-dasharray="4,2" marker-end="url(#arrowhead-green)"/>
  <text x="410" y="342" text-anchor="middle" fill="#047857" font-size="11">5. onopen</text>
  
  <!-- Step 9: Status update -->
  <line x1="510" y1="420" x2="710" y2="420" stroke="#f59e0b" stroke-width="2" marker-end="url(#arrowhead)"/>
  <text x="610" y="412" text-anchor="middle" fill="#b45309" font-size="11">6. offscreen_status(connected:true)</text>
  
  <!-- Step 10: Notify Popup -->
  <line x1="710" y1="445" x2="840" y2="445" stroke="#10b981" stroke-width="2" marker-end="url(#arrowhead-green)"/>
  <text x="775" y="437" text-anchor="middle" fill="#047857" font-size="11">7. status(connected:true)</text>
  
  <!-- Connected indicator -->
  <rect x="800" y="460" width="80" height="25" rx="4" fill="#d1fae5" stroke="#10b981" stroke-width="2"/>
  <text x="840" y="477" text-anchor="middle" fill="#047857" font-size="11" font-weight="600">✓ Connected</text>
</svg>

